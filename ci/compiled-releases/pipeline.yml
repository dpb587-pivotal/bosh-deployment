---
resources:
  - name: bosh-deployment
    type: git
    source:
      uri: https://github.com/dpb587-pivotal/bosh-deployment.git
      branch: compiled-releases-master

  - name: compiled-release-repo
    type: git
    source:
      uri: git@github.com:dpb587-pivotal/bosh-deployment.git
      branch: compiled-releases
      private_key: {{git_ssh_key}}

  # releases

  - name: bosh-release
    type: bosh-io-release
    source:
      repository: cloudfoundry/bosh

  - name: uaa-release
    type: bosh-io-release
    source:
      repository: cloudfoundry/uaa-release

  - name: credhub-release
    type: bosh-io-release
    source:
      repository: pivotal-cf/credhub-release

  - name: config-server-release
    type: bosh-io-release
    source:
      repository: cloudfoundry/config-server-release

  - name: warden-cpi
    type: bosh-io-release
    source:
      repository: cppforlife/bosh-warden-cpi-release

  - name: garden-linux
    type: bosh-io-release
    source:
      repository: cloudfoundry/garden-linux-release

  - name: garden-runc
    type: bosh-io-release
    source:
      repository: cloudfoundry/garden-runc-release

  - name: grootfs
    type: bosh-io-release
    source:
      repository: cloudfoundry/grootfs-release

  - name: dns
    type: bosh-io-release
    source:
      repository: cloudfoundry/dns-release

  # stemcells

  - name: ubuntu-trusty-stemcell
    type: bosh-io-stemcell
    source:
      name: bosh-warden-boshlite-ubuntu-trusty-go_agent

  - name: pcf-1.12-bosh
    type: metalink-repository
    source:
      uri: git+https://github.com/dpb587-pivotal/bosh-deployment.git//product/pcf-1.12/bosh #compiled-releases # branches are broken

jobs:
  - name: pcf-1.12
    plan:
      - aggregate:
        - get: bosh
          resource: pcf-1.12-bosh
          params:
            skip_download: true
      - task: details
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: bosh/main-bosh-docker
          inputs:
            - name: uaa
          run:
            path: sh
            args:
            - -exc
            - |
              curl -LJo /usr/local/bin/meta4 https://github.com/dpb587/metalink/releases/download/v0.1.0/meta4-0.1.0-linux-amd64
              chmod +x /usr/local/bin/meta4

              echo "bosh:"
              echo "  sha1: " $( meta4 --metalink=uaa/.resource/metalink.meta4 file-hash sha-1 )
              echo "  url: " $( meta4 --metalink=uaa/.resource/metalink.meta4 file-urls )

  - name: compile-bosh-release-263-ubuntu-trusty-3445
    plan:
      - aggregate:
        - get: bosh-deployment
        - get: compiled-release-repo
        - get: bosh-release
          version:
            version: "263"
        - get: ubuntu-trusty-stemcell
          version:
            version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: bosh-release
        params:
          products: 1.12/bosh
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-bosh-release-262-ubuntu-trusty-3421
    plan:
      - aggregate:
        - get: bosh-deployment
        - get: compiled-release-repo
        - get: bosh-release
          version:
            version: "262.4"
        - get: ubuntu-trusty-stemcell
          version:
            version: "3421.19"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: bosh-release
        params:
          products: 1.11/bosh
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-bosh-release-261-ubuntu-trusty-3363
    plan:
      - aggregate:
        - get: bosh-deployment
        - get: compiled-release-repo
        - get: bosh-release
          version:
            version: "261.5"
        - get: ubuntu-trusty-stemcell
          version:
            version: "3363.30"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: bosh-release
        params:
          products: 1.10/bosh
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-bosh-release-260-ubuntu-trusty-3363
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: bosh-release
            version:
              version: "260.8"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3363.30"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: bosh-release
        params:
          products: 1.9/bosh
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-bosh-release-257-ubuntu-trusty-3363
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: bosh-release
            version:
              version: "257.24"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3363.30"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: bosh-release
        params:
          products: 1.8/bosh
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-bosh-release-255-ubuntu-trusty-3363
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: bosh-release
            version:
              version: "255.14"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3363.30"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: bosh-release
        params:
          products: 1.7/bosh
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-uaa-release-30-ubuntu-trusty-3363
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: uaa-release
            version:
              version: "30.5"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3363.30"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: uaa-release
        params:
          products: 1.10/uaa
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-uaa-release-24-ubuntu-trusty-3363
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: uaa-release
            version:
              version: "24.12"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3363.30"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: uaa-release
        params:
          products: 1.9/uaa
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-uaa-release-13-ubuntu-trusty-3363
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: uaa-release
            version:
              version: "13.17"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3363.30"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: uaa-release
        params:
          products: 1.8/uaa
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-uaa-release-41-ubuntu-trusty-3421
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: uaa-release
            version:
              version: "41"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3421.19"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: uaa-release
        params:
          products: 1.11/uaa
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-uaa-release-45-ubuntu-trusty-3421
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: uaa-release
            version:
              version: "45"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3421.15"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: uaa-release
        params:
          products: 1.11/uaa-45
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-uaa-release-45-ubuntu-trusty-3445
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: compiled-release-repo
          - get: uaa-release
            version:
              version: "45"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: uaa-release
        params:
          products: 1.12/uaa
          s3_host: {{s3_host}}
          s3_bucket: {{s3_bucket}}
          s3_access_key_id: {{s3_access_key_id}}
          s3_secret_access_key: {{s3_secret_access_key}}
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-credhub-release-1-ubuntu-trusty-3445
    plan:
      - aggregate:
        - get: bosh-deployment
        - get: credhub-release
          version:
            version: "1.2.0"
        - get: ubuntu-trusty-stemcell
          version:
            version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: credhub-release
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-config-server-release-0-ubuntu-trusty-3445
    plan:
      - aggregate:
        - get: bosh-deployment
        - get: config-server-release
          version:
            version: "0.0.1"
        - get: ubuntu-trusty-stemcell
          version:
            version: "3445.18"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: config-server-release
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-dns-release-0-ubuntu-trusty-3445
    plan:
      - aggregate:
        - get: bosh-deployment
        - get: dns
          version:
            version: "0.0.4"
        - get: ubuntu-trusty-stemcell
          version:
            version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: dns
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  # bosh-lite related

  - name: compile-warden-cpi-ubuntu-trusty-3445
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: warden-cpi
            version:
              version: "34"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: warden-cpi
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-garden-linux-ubuntu-trusty-3445
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: garden-linux
            version:
              version: "0.342.0"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: garden-linux
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-garden-runc-ubuntu-trusty-3445
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: garden-runc
            version:
              version: "1.1.1"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: garden-runc
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-garden-runc-1-9-ubuntu-trusty-3445
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: garden-runc
            version:
              version: "1.9.0"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: garden-runc
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

  - name: compile-grootfs-ubuntu-trusty-3445
    plan:
      - aggregate:
          - get: bosh-deployment
          - get: grootfs
            version:
              version: "0.21.0"
          - get: ubuntu-trusty-stemcell
            version:
              version: "3445"
      - task: export-release
        file: bosh-deployment/ci/compiled-releases/tasks/export-release.yml
        privileged: true
        input_mapping:
          stemcell: ubuntu-trusty-stemcell
          release: grootfs
      - put: compiled-release-repo
        params:
          rebase: true
          repository: compiled-release-repo

resource_types:
- name: metalink-repository
  type: docker-image
  source:
    repository: dpb587/metalink-repository-resource
